<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºé¢å ±å‘Šç”¨ãƒ•ã‚©ãƒ¼ãƒ </title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
    <style>
        .ui-datepicker {
            width: 75vw;
            font-size: 1.2em;
            margin: 0 auto;
        }
        .ui-datepicker table {
            width: 100%;
            margin: 0 auto;
        }
        .ui-datepicker td span, 
        .ui-datepicker td a {
            padding: .8em .2em;
            text-align: center;
        }
        .ui-datepicker .ui-datepicker-header {
            padding: 1em 0;
        }
        .ui-datepicker .ui-datepicker-prev, 
        .ui-datepicker .ui-datepicker-next {
            width: 2em;
            height: 2em;
            top: 50%;
            transform: translateY(-50%);
        }
        .ui-datepicker .ui-datepicker-title {
            margin: 0 2.3em;
            line-height: 1.8em;
        }
        .ui-datepicker select.ui-datepicker-month, 
        .ui-datepicker select.ui-datepicker-year {
            font-size: 1em;
        }
        .datepicker[readonly] {
            background-color: #fff;
        }
    </style>
</head>
<body>

    <form class="w-75 mx-auto">
        <p class="mt-3 d-none">ãƒ‡ãƒãƒƒã‚°ç”¨Sub</p>
        <div class="d-none">
            <input class="form-control w-100 mt-1" name="userSub" readonly>
        </div>
        <p class="mt-3">å‡ºå‘ã—ãŸæ—¥ä»˜</p>
        <div>
            <input class="form-control w-100 mt-1 datepicker" name="workDate" placeholder="ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä¸‹ã•ã„" required readonly>
        </div>
        <p class="mt-3">å ±å‘Šè€…æ°å</p>
        <div>
            <input class="form-control w-100 mt-1" name="name" placeholder="ã”è‡ªèº«ã®ãŠåå‰ã‚’ã”å…¥åŠ›ãã ã•ã„" required>
        </div>
        <p class="mt-3">ã”è‡ªèº«ã®å‡ºå‘å†…å®¹</p>
        <div>
            <select class="form-control w-100 mt-1" name="assignmentDetails" required>
                <option value=""></option>
                <option value="å…¨æ—¥å‡ºå‘">å…¨æ—¥ğŸŒ•å‡ºå‘</option>
                <option value="åŠæ—¥å‡ºå‘">åŠæ—¥ğŸŒ“å‡ºå‘</option>
                <option value="å¤œé–“å‡ºå‘">å¤œé–“ğŸŒ™å‡ºå‘</option>
                <option value="å ±å‘Šã®ã¿">è‡ªåˆ†è‡ªèº«ã¯å‡ºå‘ã—ã¦ã„ãªã„ï¼ˆå ±å‘Šã®ã¿ï¼‰</option>
            </select>
        </div>
        <div id="workDetailsContainer">
            <p class="mt-3">å‡ºå‘ã—ãŸç¾å ´å</p>
            <div>
                <input class="form-control w-100 mt-1" name="workDetails" placeholder="ã€‡ã€‡é‚¸ ï½ â–³â–³ã‚´ãƒŸå¼•ã" required>
            </div>
        </div>
        <p class="mt-3">ã”è‡ªèº«ä»¥å¤–ã®å‡ºå‘çŠ¶æ³ã‚‚å ±å‘Šã•ã‚Œã¾ã™ã‹ï¼Ÿ</p>
        <div>
            <select class="form-control w-100 mt-1" name="otherAssignments" required>
                <option value=""></option>
                <option value="ã¯ã„">ã¯ã„â­•</option>
                <option value="ã„ã„ãˆ">ã„ã„ãˆâŒè‡ªåˆ†ã®å‡ºå‘çŠ¶æ³ã ã‘å ±å‘Šã—ã¾ã™ã€‚</option>
            </select>
        </div>
        <hr class="mt-4">
        <div id="otherDetailsContainer" style="display: none;">
            <p class="mt-3">ã”è‡ªèº«ä»¥å¤–ã®å‡ºå‘çŠ¶æ³</p>
            <p class="text-muted">â€»å‡ºå‘çŠ¶æ³ã”ã¨ã«äººæ•°ã¯åˆ†ã‘ã¦ã”å…¥åŠ›ãã ã•ã„ã€‚</p>
        </div>

        <!-- 1ã¤ç›®ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <p class="mt-3 mb-0" style="display: none;" id="label1">1.</p>
        <div id="otherAssignmentContainer1" class="otherAssignmentContainer" style="display: none;">            
            <div>
                <input class="form-control w-100 mt-3" name="otherName1" type="text" placeholder="ãŠåå‰/æ‰€å±å›£ä½“å">
            </div>
            <div class="mt-3">
                <p class="mb-2">å‡ºå‘ã®äººæ•°</p>
                <div class="row">
                    <div class="col-4">
                        <input class="form-control w-100" name="fullDayCount1" type="number" min="0" 
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å…¨æ—¥ğŸŒ•">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="halfDayCount1" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="åŠæ—¥ğŸŒ“">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="nightCount1" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å¤œé–“ğŸŒ™">
                    </div>
                </div>
            </div>
            <div>
                <input class="form-control w-100 mt-3" name="otherSiteName1" type="text" placeholder="â€»å‡ºå‘å…ˆã®ç¾å ´å">
            </div>
        </div>

        <!-- 2ã¤ç›®ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <p class="mt-3 mb-0" style="display: none;" id="label2">2.</p>
        <div id="otherAssignmentContainer2" class="otherAssignmentContainer" style="display: none;">            
            <div>
                <input class="form-control w-100 mt-3" name="otherName2" type="text" placeholder="ãŠåå‰/æ‰€å±å›£ä½“å">
            </div>
            <div class="mt-3">
                <p class="mb-2">å‡ºå‘ã®äººæ•°</p>
                <div class="row">
                    <div class="col-4">
                        <input class="form-control w-100" name="fullDayCount2" type="number" min="0" 
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å…¨æ—¥ğŸŒ•">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="halfDayCount2" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="åŠæ—¥ğŸŒ“">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="nightCount2" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å¤œé–“ğŸŒ™">
                    </div>
                </div>
            </div>
            <div>
                <input class="form-control w-100 mt-3" name="otherSiteName2" type="text" placeholder="â€»å‡ºå‘å…ˆã®ç¾å ´å">
            </div>
        </div>

        <!-- 3ã¤ç›®ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <p class="mt-3 mb-0" style="display: none;" id="label3">3.</p>
        <div id="otherAssignmentContainer3" class="otherAssignmentContainer" style="display: none;">            
            <div>
                <input class="form-control w-100 mt-3" name="otherName3" type="text" placeholder="ãŠåå‰/æ‰€å±å›£ä½“å">
            </div>
            <div class="mt-3">
                <p class="mb-2">å‡ºå‘ã®äººæ•°</p>
                <div class="row">
                    <div class="col-4">
                        <input class="form-control w-100" name="fullDayCount3" type="number" min="0" 
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å…¨æ—¥ğŸŒ•">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="halfDayCount3" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="åŠæ—¥ğŸŒ“">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="nightCount3" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å¤œé–“ğŸŒ™">
                    </div>
                </div>
            </div>
            <div>
                <input class="form-control w-100 mt-3" name="otherSiteName3" type="text" placeholder="â€»å‡ºå‘å…ˆã®ç¾å ´å">
            </div>
        </div>

        <!-- 4ã¤ç›®ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <p class="mt-3 mb-0" style="display: none;" id="label4">4.</p>
        <div id="otherAssignmentContainer4" class="otherAssignmentContainer" style="display: none;">            
            <div>
                <input class="form-control w-100 mt-3" name="otherName4" type="text" placeholder="ãŠåå‰/æ‰€å±å›£ä½“å">
            </div>
            <div class="mt-3">
                <p class="mb-2">å‡ºå‘ã®äººæ•°</p>
                <div class="row">
                    <div class="col-4">
                        <input class="form-control w-100" name="fullDayCount4" type="number" min="0" 
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å…¨æ—¥ğŸŒ•">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="halfDayCount4" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="åŠæ—¥ğŸŒ“">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="nightCount4" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å¤œé–“ğŸŒ™">
                    </div>
                </div>
            </div>
            <div>
                <input class="form-control w-100 mt-3" name="otherSiteName4" type="text" placeholder="â€»å‡ºå‘å…ˆã®ç¾å ´å">
            </div>
        </div>

        <!-- 5ã¤ç›®ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
        <p class="mt-3 mb-0" style="display: none;" id="label5">5.</p>
        <div id="otherAssignmentContainer5" class="otherAssignmentContainer" style="display: none;">            
            <div>
                <input class="form-control w-100 mt-3" name="otherName5" type="text" placeholder="ãŠåå‰/æ‰€å±å›£ä½“å">
            </div>
            <div class="mt-3">
                <p class="mb-2">å‡ºå‘ã®äººæ•°</p>
                <div class="row">
                    <div class="col-4">
                        <input class="form-control w-100" name="fullDayCount5" type="number" min="0" 
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å…¨æ—¥ğŸŒ•">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="halfDayCount5" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="åŠæ—¥ğŸŒ“">
                    </div>
                    <div class="col-4">
                        <input class="form-control w-100" name="nightCount5" type="number" min="0"
                                pattern="\d*" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                placeholder="å¤œé–“ğŸŒ™">
                    </div>
                </div>
            </div>
            <div>
                <input class="form-control w-100 mt-3" name="otherSiteName5" type="text" placeholder="â€»å‡ºå‘å…ˆã®ç¾å ´å">
            </div>
        </div>

        <input type="submit" class="mt-4 btn btn-primary" value="é€ä¿¡">
    </form>
    
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        const liffId = "2006480262-mQBgbR1d";
        initializeLiff(liffId);

        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                initializeApp();
            }).catch((err) => {
                console.log('LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ ', err);
            });
        }

        function initializeApp() {
            liff.getProfile()
                .then(profile => {
                    $('input[name="name"]').val(profile.displayName);
                    return liff.getDecodedIDToken();
                })
                .then(decodedIDToken => {
                    $('input[name="userSub"]').val(decodedIDToken.sub);
                })
                .catch((err) => {
                    console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ ', err);
                });
        }

        function sendText(text) {
            liff.sendMessages([{
                'type': 'text',
                'text': text
            }]).then(function () {
                liff.closeWindow();
            }).catch(function (error) {
                window.alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ ' + error);
            });
        }

        const params = (new URL(document.location)).searchParams;
        const key = params.get('key');

        $(document).ready(function () {
            $.datepicker.regional['ja'] = {
                closeText: 'é–‰ã˜ã‚‹',
                prevText: 'å‰æœˆ',
                nextText: 'æ¬¡æœˆ',
                currentText: 'ä»Šæ—¥',
                monthNames: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                monthNamesShort: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                dayNames: ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'],
                dayNamesShort: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'],
                dayNamesMin: ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'],
                weekHeader: 'é€±',
                dateFormat: 'yy/mm/dd',
                firstDay: 0,
                isRTL: false,
                showMonthAfterYear: true,
                yearSuffix: ''
            };
            
            $.datepicker.setDefaults($.datepicker.regional['ja']);
            
            function updateYearDisplay() {
                setTimeout(function() {
                    const currentYear = $('.ui-datepicker-year').text();
                    $('.ui-datepicker-year').replaceWith(`<span class="ui-datepicker-year">${currentYear}å¹´</span>`);
                }, 1);
            }
            
            $(".datepicker").datepicker({
                changeMonth: true,
                changeYear: false,
                showButtonPanel: true,
                beforeShow: function(input, inst) {
                    updateYearDisplay();
                },
                onChangeMonthYear: function(year, month, inst) {
                    updateYearDisplay();
                }
            });

            // assignmentDetailsã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’æ›´æ–°
            $('select[name="assignmentDetails"]').change(function() {
                const workDetailsContainer = $('#workDetailsContainer');
                const workDetailsInput = $('input[name="workDetails"]');
                const otherAssignmentsSelect = $('select[name="otherAssignments"]');
                
                if ($(this).val() === 'å ±å‘Šã®ã¿') {
                    // workDetailsã®è¨­å®š
                    workDetailsContainer.hide();
                    workDetailsInput.prop('required', false);
                    
                    // otherAssignmentsã®è¨­å®š
                    otherAssignmentsSelect.val('ã¯ã„');
                    otherAssignmentsSelect.prop('disabled', true);
                    
                    // é–¢é€£ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤º
                    $('#otherDetailsContainer').show();
                    $('.otherAssignmentContainer').show();
                    $('.mt-3.mb-0[id^="label"]').show();
                    
                    // å„otherNameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦otherSiteNameã®requiredå±æ€§ã‚’è¨­å®š
                    for (let i = 1; i <= 5; i++) {
                        const hasName = $(`input[name="otherName${i}"]`).val().trim() !== '';
                        $(`input[name="otherSiteName${i}"]`).prop('required', hasName);
                    }
                } else {
                    // é€šå¸¸ã®å‹•ä½œã«æˆ»ã™
                    workDetailsContainer.show();
                    workDetailsInput.prop('required', true);
                    otherAssignmentsSelect.prop('disabled', false);
                }
            });

            // å„otherNameãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¿½åŠ 
            for (let i = 1; i <= 5; i++) {
                $(`input[name="otherName${i}"]`).on('input', function() {
                    const isReportOnly = $('select[name="assignmentDetails"]').val() === 'å ±å‘Šã®ã¿';
                    const hasValue = $(this).val().trim() !== '';
                    
                    if (isReportOnly) {
                        $(`input[name="otherSiteName${i}"]`).prop('required', hasValue);
                    }
                });
            }

            // otherAssignmentsã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’æ›´æ–°
            $('select[name="otherAssignments"]').change(function() {
                const otherDetailsContainer = $('#otherDetailsContainer');
                const otherAssignmentContainer = $('.otherAssignmentContainer');
                const labels = $('.mt-3.mb-0[id^="label"]');
                
                if ($(this).val() === 'ã¯ã„') {
                    otherDetailsContainer.show();
                    otherAssignmentContainer.show();
                    labels.show();
                    
                    // å ±å‘Šã®ã¿ã®å ´åˆã€otherSiteNameã®requiredå±æ€§ã‚’è¨­å®š
                    if ($('select[name="assignmentDetails"]').val() === 'å ±å‘Šã®ã¿') {
                        for (let i = 1; i <= 5; i++) {
                            const hasName = $(`input[name="otherName${i}"]`).val().trim() !== '';
                            $(`input[name="otherSiteName${i}"]`).prop('required', hasName);
                        }
                    }
                } else {
                    otherDetailsContainer.hide();
                    otherAssignmentContainer.hide();
                    labels.hide();
                    
                    // requiredå±æ€§ã‚’è§£é™¤
                    $('input[name^="otherSiteName"]').prop('required', false);
                }
            });
        });

        $(function () {
            $('form').submit(function () {
                const workDate = $('input[name="workDate"]').val();
                const name = $('input[name="name"]').val();
                const userSub = $('input[name="userSub"]').val();
                const assignmentDetails = $('select[name="assignmentDetails"]').val();
                const workDetails = assignmentDetails === 'å ±å‘Šã®ã¿' ? '' : $('input[name="workDetails"]').val();
                const otherAssignments = $('select[name="otherAssignments"]').val();
                
                let msg = `è­˜åˆ¥å­ï¼š${userSub}\nå‡ºå‘æ—¥ï¼š${workDate}\næ°åï¼š${name}\nå‡ºå‘å†…å®¹ï¼š${assignmentDetails}\nç¾å ´åï¼š${workDetails}\nä»–ã®å‡ºå‘å ±å‘Šï¼š${otherAssignments}`;

                if (otherAssignments === 'ã¯ã„') {
                    for (let i = 1; i <= 5; i++) {
                        const otherName = $(`input[name="otherName${i}"]`).val();
                        const fullDay = $(`input[name="fullDayCount${i}"]`).val();
                        const halfDay = $(`input[name="halfDayCount${i}"]`).val();
                        const night = $(`input[name="nightCount${i}"]`).val();
                        const siteName = $(`input[name="otherSiteName${i}"]`).val();

                        if (otherName) {
                            let counts = [];
                            if (fullDay > 0) counts.push(`å…¨æ—¥${fullDay}å`);
                            if (halfDay > 0) counts.push(`åŠæ—¥${halfDay}å`);
                            if (night > 0) counts.push(`å¤œé–“${night}å`);

                            const displaySiteName = siteName.trim() ? siteName : workDetails;
                            msg += `\n${i}. ${otherName}/${counts.join(',')}/${displaySiteName}`;
                        }
                    }
                }

                sendText(msg);
                return false;
            });
        });
    </script>

</body>
</html>
